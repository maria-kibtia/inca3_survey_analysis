---
title: "Association between daily protein intake and the level of physical activity among adult French female in inca3 survey"
author: "mkh"
date: "20 October 2023"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
subtitle: R project
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction: 

## Objectives
The primary objective is to find if there is an association between daily protein intake and level of physical activity among adult French female in inca3 survey. The secondary objective is to create a parsimonious descriptive model using some predictor variables, and reporting the prediction accuracy of the model.

```{r packages, include=FALSE}
library(readr)
library(tidyverse)
library(ggplot2)
library(data.table)
library(dplyr)
library(epiDisplay)
library(gtsummary)
library(broom) ## for tidy() in model summary
```

## Loading dataset "individual"
```{r upload description data, error=FALSE}
ind <- read_csv("description_indiv_decode.csv")
```

## Loading dataset "active"
```{r loading actphys}
load("C:/Users/rezwa/OneDrive/Desktop/EHESP Biostat/M2_Intro to R/Intro.to.Rlabs/MKH_intro_project_submission/actphys_sedent_decode.rda")
active <- actphys_sedent_decode
```

```{r}
act <- active[, c("NOIND", "nap")] ## keeping these 2 variables & id from active dataset
```

## 1.1 Merging individual dataset & active datasets
```{r join active and individual datasets}
library(dplyr)

df1 <- inner_join(ind, act, by = "NOIND") %>%
  filter(!is.na(tage_PS)) ## merging datasets with common values only and for the adult population only
```

## Uploading dataset on nutrition
```{r upload nutrition data}
load("C:/Users/rezwa/OneDrive/Desktop/EHESP Biostat/M2_Intro to R/Intro.to.Rlabs/MKH_intro_project_submission/apports_nut_alim_decode.rda")
```
```{r}
nutrition <- apports_nut_alim_decode
nutrition$NOIND <- nutrition$`Numéro d'individu`
```

## 1.2 Merging previous dataset with nutrition dataset and naming it nut
```{r keeping ID and outcome in nutrition}
nutri <- nutrition[, c("NOIND", "Protéines (g/j)")]## keeping these 2 variables & id from nutrition dataset
nut <- inner_join(df1, nutri, by = "NOIND") %>%
  filter(!is.na(tage_PS))
```

## 1.3 Data wrangling
```{r changing column names}
setnames(nut, old = c('tage_PS','sex_PS', 'imc', 'Protéines (g/j)'), new = c('age', 'sex', 'bmi', 'protein'))
setnames(nut, old = c('etude_4cl_interv','situ_prof_5cl_interv', 'statnut', 'agglo_5cl'), 
         new = c('education', 'employment', 'bmi_cat','city_dwellers'))
```

```{r subsetting data}
nut <- nut[, c("NOIND", "age", "sex", "bmi", "education", "employment", "bmi_cat", 
               "city_dwellers", "protein", "nap")]
```

```{r saving final dataset}
write.csv(nut, file = "final_dataset_nutrition.csv")
```

```{r}
## let´s look at age first
typeof(nut$age)
```

```{r age}
table(nut$age)
```
## Materials and methods
# 2.1 Subsetting the sample: 
The sample is adult french population, exclusion criteria = age <18 years
```{r subsetting sample}
nut <- nut %>%
  mutate(age_categories = ifelse(age %in% c("1-3 ans", "4-6 ans", "7-10 ans", "11-14 ans", "15-17 ans"), "minors", "adults"))

nt <- nut %>%
  filter(age_categories == "adults") %>%
  mutate(age_categories = factor(age_categories, levels = "adults"))
```

## Choosing strata: adult female population, exclusion criteria = male
```{r choosing strata}
strata <- "Femme"
nt <- nt %>% filter(sex == strata)# using dplyr
nt <- nt %>% select(-age_categories, -NOIND, -bmi, -sex)
```

# 2.2. Outcome variable: Categorizing the var= "protein" which is protein intake per day in grams.
```{r outcome var}
hist(nt$protein)
```
```{r}
nt$protein <- ifelse(nt$protein >= 70, "recommended", "low") # using the French recommended intake of 1g/kg/day
nt$protein <- factor(nt$protein)
table(nt$protein)
```

# 2.3. **Exposure variable = "nap"**= level of physical activity. Other variables = age in categories, BMI categories, education, employment, city_dweller. Converting categorical variables to factors:
```{r changing to factors}
vars_to_factor <- c("age", "employment", "bmi_cat", "city_dwellers", "nap")
nt[vars_to_factor] <- lapply(nt[vars_to_factor], factor)
```

# 2.4 Summary table (preliminary): 
Also, checking the proportion/counts in each co-variates, to see if any of them contains count <5. 
```{r descriptive table raw}
nt %>% tbl_summary(by = protein) 
```

# 2.5 Data cleaning: Assigning levels of covariates(relevelling) and recoding 
Education co-variate has a count <5 in one of the sublevels. Changing levels & relabeling in the next section.
```{r}
sum(is.na(nt$education))
nt$education <- ifelse(nt$education %in% 
                         c("Bac +1/3", "Bac +4 et plus"), "graduate", "undergraduate")
```
```{r}
table(nt$education)
nt$education <- as.factor(nt$education)
```
```{r}
sum(is.na(nt$employment))


nt$employment <- ifelse(nt$employment %in% c("Au foyer, autre inactif", "Chômeur", "Etudiant"), "unemployed", 
                        ifelse(nt$employment == "Occupe un emploi", "employed", 
                               ifelse(nt$employment == "Retraité", "retired", nt$employment)))
nt$employment <- as.factor(nt$employment)
```
```{r}
table(nt$employment) #survey takers who are not working then and not retired are grouped as unemployed
```
Defining the city dwellers as "cities" if they live in an urban setting with >100000 population, and as "small towns" if they live in an urban area with <100000 people. The rural dwellers has reported to live in rural settings.
```{r}
nt$city_dwellers <- ifelse(nt$city_dwellers %in% 
                             c(">=100 000 hab.", "Agglo Paris"), "cities",
                          ifelse(nt$city_dwellers %in% 
                                   c("2 000-19 999 hab.", "20 000-99 999 hab."), "small towns",
                                 ifelse(nt$city_dwellers == "Rural", "rural", 
                                        nt$city_dwellers)))
table(nt$city_dwellers) 
```
```{r}
nt$city_dwellers <- relevel(as.factor(nt$city_dwellers), ref = "rural")
table(nt$city_dwellers)
```
```{r}
table(nt$nap)
levels(nt$nap) <- c("high", "low", "moderate")
nt$nap <- relevel(as.factor(nt$nap), ref = "low")
table(nt$nap)
```
BMI categories are grouped to "obese" if obese or morbidly obese (i.e. BMI >= 30 kg/m2) and as "normal" if BMI <= 25kg/m2. The overweight people have a BMI = 25-30 kg/m2
```{r}
table(nt$bmi_cat)
nt <- nt %>%
  mutate(bmi_cat = recode(bmi_cat,
    "Maigreur" = "normal",
    "Normal" = "normal",
    "Obésité" = "obese",
    "Obésité morbide (chez les 2 ans et +)" = "obese",
    "Surpoids" = "overweight"
  ))

nt$bmi_cat <- relevel(nt$bmi_cat, ref = "overweight")
nt$bmi_cat <- relevel(nt$bmi_cat, ref = "normal") # re-leveling for a gradient
table(nt$bmi_cat)
```
## Final Descriptive Table ##
```{r}
library(summarytools)

nt %>%
  tbl_summary(by = protein, missing = "no") %>% 
  bold_labels() %>% 
  italicize_levels() %>%
  modify_caption("Table-1. Characteristics of adult females in French INCA-survey")

```

```{r table 2}
table(nt$education, nt$bmi_cat)
```

# 2.5 Descriptive plots

# 2.5.1 Plotting age-bmi by protein intake
```{r plot age-bmi by protein intake}
ggplot(nt, aes(x = age, fill= bmi_cat, missing="no")) + 
  geom_bar(position = "dodge") + 
  scale_fill_discrete(na.value = "NA") + 
  facet_wrap(~ protein) + 
  ggtitle("Plot 1. Age by BMi categories in two different groups of Protein intake")
```
The bmi categories by age categories were fairly similar in two groups of protein intake in this sample dataset.

# 2.5.2 Plotting exposure with outcome
```{r plot 2. exposure by outcome}
nt$nap <- relevel(nt$nap, ref = "moderate")
nt$nap <- relevel(nt$nap, ref = "high") # re-leveling for a gradient

ggplot(nt, aes(x = protein, fill= nap, missing="no")) + 
  geom_bar(position = "dodge") + 
  scale_fill_discrete(na.value = "NA") + 
  ggtitle("Plot 2. Level of physical activity in two different groups of protein intake")
```
More people reported having low physical activities in the low protein intake group, compared to the high protein intake group, where most participants reported to have moderate physical activity.

## 3 Statistical approach: 
# 3.1 Bivariate analysis with the exposure variable
```{r}
chi2_exp <- chisq.test(table(nt$protein, nt$nap))
p1 <- chi2_exp$p.value
print(p1)
```
The p-value of chi2 test between the exposure and sugar intake is `r p1`. 

# 3.2 Bivariate analysis summary table
```{r}
nt %>% tbl_summary(by = protein, missing = "no") %>% add_p() %>% 
  bold_labels() %>% 
  italicize_levels() %>%
  modify_caption("Table-2. Bivariate analysis of adults´daily protein intake with covariates")
```

#3.3. Regression modeling:
```{r}
# Relevel the "protein" variable with "low" as the reference level
nt$protein <- relevel(nt$protein, ref = "low")

# Fit the logistic regression model 
full <- glm(protein ~ .-education, data = nt, family = binomial(link = "logit"))
summary(full)
```
#3.1 Automatic stepwise regression model´s variable selection (backward selection)
There are 35 NAs in nap variable. So, let´s drop the NAs
```{r dropping NAs}
sum(is.na(nt$nap))   # outcome has 3% NAs.
nt <- nt[complete.cases(nt), ]   # So, let´s drop the cases with NAs
```

```{r}
full <- glm(protein ~ .-education, data = nt, family = binomial(link = "logit"))
summary(full)
```
# Stepwise automatic backwards variable selection
```{r}
step <- step(full,direction = "backward")
summary(step)
```
Let´s store the model
```{r}
back <- glm(protein ~ age + employment + city_dwellers + nap, data = nt, family = binomial(link = "logit"))
```

# 3.1 Reporting the results of regression models
```{r}
extract_OR <- function(model) {
  p_values <- summary(model)$coefficients[-1, "Pr(>|z|)"]  # Exclude the intercept term, and give all p-values
  odds_ratios <- exp(coef(model))[-1]    # report ORs
  
  results <- ifelse(p_values > 0.05, "not significant", odds_ratios)
  
  return(results)
}

results <- extract_OR(back)                                                                      
print(results)
```
### Description of Results: just coefficients/ORs
The odds ratios of my model are `r results`

#3.2 Summary table: Regression table
```{r}
tbl_regression(back, exponentiate = TRUE) %>% 
  bold_labels() %>% 
  italicize_levels() %>%
  modify_caption("Table-3. Regression modeling of adults´ protein intake with other covariates")
```

## 3.4 Plotting OR with CI
```{r}
modsummary <- tidy(back)
modsummary <- modsummary %>%
  mutate(odds_ratio = exp(estimate))

# Plot odds ratios with confidence intervals
ggplot(modsummary, aes(x = term, y = exp(estimate), ymin = exp(estimate - 1.96 * std.error), ymax = exp(estimate + 1.96 * std.error))) + 
  geom_point(position = position_dodge(width = 0.5), size = 3, color = "blue") +  
  geom_errorbar(width = 0.2, position = position_dodge(width = 0.5)) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Plot 3. Odds Ratios with Confidence Intervals in the back model",
       x = "Variables",
       y = "Odds Ratio (95% CI)")
```
## 3.5 Plotting ROC curve
```{r, include=FALSE}
library(pROC)
```
```{r}
# Subset the response and predictor vectors to match in length
rs <- nt$protein[1:length(predict(back, type = "response"))]
pr <- predict(back, type = "response")

# Create the ROC curve
ROC <- roc(response = rs, predictor = pr)
plot(ROC)
```
```{r}
# Calculate AUC
auc <- auc(ROC)
auc
```
The model can predict the protein intake of adult population in `r strata` with an accuracy of `r auc`*100 percent times.
